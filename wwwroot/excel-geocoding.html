<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Excel Geocoding - Direct Export</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background-color: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: #fafafa;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #333;
        }
        input[type="file"], button, select, input[type="text"] {
            padding: 12px;
            margin: 5px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        input[type="text"] {
            width: 100%;
            box-sizing: border-box;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            cursor: pointer;
            font-weight: bold;
            margin-right: 10px;
        }
        button:hover {
            background-color: #0056b3;
        }
        button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
        .result {
            margin-top: 15px;
            padding: 15px;
            border-radius: 5px;
            white-space: pre-wrap;
            font-family: monospace;
        }
        .success {
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .error {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        .info {
            background-color: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
        }
        .warning {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
        }
        .download-link {
            display: inline-block;
            margin-top: 10px;
            padding: 10px 20px;
            background-color: #28a745;
            color: white;
            text-decoration: none;
            border-radius: 4px;
            font-weight: bold;
        }
        .download-link:hover {
            background-color: #218838;
        }
        .progress {
            width: 100%;
            height: 20px;
            background-color: #f0f0f0;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }
        .progress-bar {
            height: 100%;
            background-color: #007bff;
            width: 0%;
            transition: width 0.3s ease;
        }
        .format-options {
            display: flex;
            gap: 20px;
            margin: 10px 0;
        }
        .format-option {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .exports-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
        }
        .export-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            border-bottom: 1px solid #eee;
        }
        .export-item:last-child {
            border-bottom: none;
        }
        .single-address-result {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            margin-top: 15px;
        }
        .result-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 10px;
        }
        .result-item {
            background-color: white;
            padding: 10px;
            border-radius: 4px;
            border: 1px solid #ddd;
        }
        .result-label {
            font-weight: bold;
            color: #495057;
            margin-bottom: 5px;
        }
        .result-value {
            color: #212529;
            word-break: break-all;
        }
        .coordinates {
            display: flex;
            gap: 10px;
        }
        .coordinate-item {
            flex: 1;
            background-color: white;
            padding: 10px;
            border-radius: 4px;
            border: 1px solid #ddd;
            text-align: center;
        }
        .coordinate-label {
            font-weight: bold;
            color: #495057;
            font-size: 12px;
            margin-bottom: 5px;
        }
        .coordinate-value {
            color: #212529;
            font-size: 16px;
            font-weight: bold;
        }
        .map-container {
            margin-top: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            overflow: hidden;
        }
        #map {
            height: 400px;
            width: 100%;
        }
        .action-buttons {
            margin-top: 15px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        .btn-export {
            background-color: #17a2b8;
        }
        .btn-export:hover {
            background-color: #138496;
        }
        .btn-copy {
            background-color: #6c757d;
        }
        .btn-copy:hover {
            background-color: #545b62;
        }
        .copy-success {
            background-color: #28a745 !important;
        }
        .limit-info {
            background-color: #e7f3ff;
            border: 1px solid #b3d9ff;
            border-radius: 4px;
            padding: 10px;
            margin: 10px 0;
            font-size: 14px;
        }
        .limit-warning {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 4px;
            padding: 10px;
            margin: 10px 0;
            font-size: 14px;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 15px 0;
        }
        .stat-item {
            background-color: white;
            padding: 15px;
            border-radius: 5px;
            border: 1px solid #ddd;
            text-align: center;
        }
        .stat-number {
            font-size: 24px;
            font-weight: bold;
            color: #007bff;
        }
        .stat-label {
            font-size: 12px;
            color: #6c757d;
            margin-top: 5px;
        }
        .live-logs-container {
            margin-top: 20px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: #f0f0f0;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
            overflow-y: auto;
            max-height: 200px;
        }
        .live-logs {
            color: #333;
        }
        .configuration-display {
            background-color: #f0f0f0;
            padding: 15px;
            border-radius: 5px;
            border: 1px solid #ddd;
            font-family: monospace;
            font-size: 14px;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üìä Excel Geocoding - Direct Export</h1>
        <p>Upload an Excel file with addresses and get back an Excel file with coordinates (X, Y) without using a database.</p>
        
        <div class="limit-info" id="costControlInfo">
            <strong>üí∞ Cost Control:</strong> Loading configuration...
        </div>
        
        <div class="section">
            <h2>üîç Check Single Address</h2>
            <div class="form-group">
                <label for="singleAddress">Enter an address to geocode:</label>
                <input type="text" id="singleAddress" placeholder="Enter address here (e.g., ÿ™Ÿáÿ±ÿßŸÜ ÿ™Ÿáÿ±ÿßŸÜ ÿÆ€åÿßÿ®ÿßŸÜ ŸàŸÑ€åÿπÿµÿ±)" style="width: 100%;">
            </div>
            <button onclick="checkSingleAddress()" id="singleAddressBtn">üîç Check Address</button>
            <div id="singleAddressResult" class="single-address-result" style="display: none;"></div>
            <div id="mapContainer" class="map-container" style="display: none;">
                <div id="map"></div>
            </div>
        </div>

        <div class="section">
            <h2>üìÅ Upload Excel File & Export Results</h2>
            <div class="form-group">
                <label for="excelFile">Select Excel file (.xlsx or .xls):</label>
                <input type="file" id="excelFile" accept=".xlsx,.xls">
            </div>
            
            <div class="format-options">
                <div class="format-option">
                    <input type="radio" id="detailedFormat" name="format" value="detailed" checked>
                    <label for="detailedFormat">Detailed Format (with status, errors)</label>
                </div>
                <div class="format-option">
                    <input type="radio" id="simpleFormat" name="format" value="simple">
                    <label for="simpleFormat">Simple Format (Address, X, Y only)</label>
                </div>
            </div>
            
            <button onclick="processAndExport()" id="processBtn">üöÄ Process & Export to Excel</button>
            <div class="progress" id="progressBar" style="display: none;">
                <div class="progress-bar" id="progressBarFill"></div>
            </div>
            <div id="processResult" class="result" style="display: none;"></div>
        </div>

        <div class="section">
            <h2>üìù Process Address List</h2>
            <div class="form-group">
                <label for="addressList">Enter addresses (one per line):</label>
                <textarea id="addressList" rows="6" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;" placeholder="Enter addresses here, one per line..."></textarea>
            </div>
            
            <div class="format-options">
                <div class="format-option">
                    <input type="radio" id="detailedFormat2" name="format2" value="detailed" checked>
                    <label for="detailedFormat2">Detailed Format</label>
                </div>
                <div class="format-option">
                    <input type="radio" id="simpleFormat2" name="format2" value="simple">
                    <label for="simpleFormat2">Simple Format</label>
                </div>
            </div>
            
            <button onclick="processAddressList()" id="processListBtn">üöÄ Process Address List</button>
            <div id="processListResult" class="result" style="display: none;"></div>
        </div>

        <div class="section">
            <h2>üìÇ Download Exports</h2>
            <button onclick="listExports()">üîÑ Refresh Export List</button>
            <div id="exportsList" class="exports-list" style="display: none;"></div>
        </div>

        <div class="section">
            <h2>üìä Live API Call Logs</h2>
            <div class="form-group">
                <button onclick="startLiveLogs()" id="startLogsBtn">üî¥ Start Live Logs</button>
                <button onclick="stopLiveLogs()" id="stopLogsBtn" style="display: none;">‚èπÔ∏è Stop Live Logs</button>
                <button onclick="clearLogs()" id="clearLogsBtn">üóëÔ∏è Clear Logs</button>
            </div>
            <div id="liveLogsContainer" class="live-logs-container" style="display: none;">
                <div id="liveLogs" class="live-logs"></div>
            </div>
        </div>

        <div class="section">
            <h2>‚öôÔ∏è Current Configuration</h2>
            <div class="form-group">
                <button onclick="loadConfiguration()" id="refreshConfigBtn">üîÑ Refresh Configuration</button>
            </div>
            <div id="configurationDisplay" class="configuration-display">
                <p>Loading configuration...</p>
            </div>
        </div>
    </div>

    <script>
        const baseUrl = window.location.origin;
        let map = null;
        let currentMarker = null;
        let eventSource = null;

        function initMap() {
            if (map) {
                map.remove();
            }
            
            // Initialize map centered on Iran
            map = L.map('map').setView([32.4279, 53.6880], 6);
            
            // Add OpenStreetMap tiles
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors'
            }).addTo(map);
        }

        function addMarkerToMap(lat, lng, address) {
            if (currentMarker) {
                map.removeLayer(currentMarker);
            }
            
            currentMarker = L.marker([lat, lng]).addTo(map);
            currentMarker.bindPopup(`<b>üìç ${address}</b><br>Lat: ${lat}<br>Lng: ${lng}`).openPopup();
            
            // Center map on the marker
            map.setView([lat, lng], 15);
        }

        function showProcessingLimits(result) {
            if (result.processingLimits && result.processingLimits.enabled) {
                let limitMessage = `üìä Processing Limits: ${result.processingLimits.maxAddressesPerFile} addresses per file`;
                
                if (result.processingLimits.limitApplied) {
                    limitMessage += `\n‚ö†Ô∏è Limit applied: ${result.processingLimits.skippedRows || result.processingLimits.skippedCount} addresses skipped to save costs`;
                }
                
                return limitMessage;
            }
            return "";
        }

        function showDetailedStats(result) {
            let statsHtml = '';
            
            if (result.totalRows !== undefined) {
                // Excel file processing
                statsHtml = `
                    <div class="stats-grid">
                        <div class="stat-item">
                            <div class="stat-number">${result.totalRows}</div>
                            <div class="stat-label">Total Rows in File</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number">${result.processedRows}</div>
                            <div class="stat-label">Rows Processed</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number">${result.skippedRows}</div>
                            <div class="stat-label">Rows Skipped</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number">${result.processingLimits.apiCallsMade}</div>
                            <div class="stat-label">API Calls Made</div>
                        </div>
                    </div>
                `;
            } else if (result.totalInputCount !== undefined) {
                // Address list processing
                statsHtml = `
                    <div class="stats-grid">
                        <div class="stat-item">
                            <div class="stat-number">${result.totalInputCount}</div>
                            <div class="stat-label">Total Addresses Input</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number">${result.processedCount}</div>
                            <div class="stat-label">Addresses Processed</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number">${result.skippedCount}</div>
                            <div class="stat-label">Addresses Skipped</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number">${result.processingLimits.apiCallsMade}</div>
                            <div class="stat-label">API Calls Made</div>
                        </div>
                    </div>
                `;
            }
            
            return statsHtml;
        }

        async function checkSingleAddress() {
            const addressInput = document.getElementById('singleAddress');
            const resultDiv = document.getElementById('singleAddressResult');
            const mapContainer = document.getElementById('mapContainer');
            const checkBtn = document.getElementById('singleAddressBtn');
            
            const address = addressInput.value.trim();
            if (!address) {
                showSingleAddressResult(resultDiv, 'Please enter an address to check.', 'error');
                return;
            }

            try {
                checkBtn.disabled = true;
                checkBtn.textContent = 'üîç Checking...';

                const response = await fetch(`${baseUrl}/api/excelgeocoding/geocode-and-export?simpleFormat=false`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify([address])
                });

                const result = await response.json();
                
                if (response.ok) {
                    if (result.successCount > 0 && result.geocodedAddresses && result.geocodedAddresses.length > 0) {
                        const geocodedAddress = result.geocodedAddresses[0];
                        
                        if (geocodedAddress.status === 'Success') {
                            // Initialize map
                            initMap();
                            mapContainer.style.display = 'block';
                            
                            // Add marker to map
                            addMarkerToMap(geocodedAddress.latitude, geocodedAddress.longitude, geocodedAddress.fullAddress);
                            
                            const resultHtml = `
                                <div style="margin-bottom: 15px;">
                                    <h3 style="color: #28a745; margin: 0 0 10px 0;">‚úÖ Address Geocoded Successfully!</h3>
                                </div>
                                <div class="result-grid">
                                    <div class="result-item">
                                        <div class="result-label">üìç Original Address:</div>
                                        <div class="result-value">${geocodedAddress.fullAddress}</div>
                                    </div>
                                    <div class="result-item">
                                        <div class="result-label">üìù Formatted Address:</div>
                                        <div class="result-value">${geocodedAddress.geocodedAddress || 'N/A'}</div>
                                    </div>
                                </div>
                                <div class="coordinates" style="margin-top: 15px;">
                                    <div class="coordinate-item">
                                        <div class="coordinate-label">Longitude (X)</div>
                                        <div class="coordinate-value">${geocodedAddress.longitude || 'N/A'}</div>
                                    </div>
                                    <div class="coordinate-item">
                                        <div class="coordinate-label">Latitude (Y)</div>
                                        <div class="coordinate-value">${geocodedAddress.latitude || 'N/A'}</div>
                                    </div>
                                </div>
                                <div class="action-buttons">
                                    <button onclick="exportSingleAddress('${geocodedAddress.fullAddress}', ${geocodedAddress.longitude}, ${geocodedAddress.latitude})" class="btn-export">
                                        üìä Export to Excel
                                    </button>
                                    <button onclick="copyCoordinates(${geocodedAddress.longitude}, ${geocodedAddress.latitude})" class="btn-copy">
                                        üìã Copy Coordinates
                                    </button>
                                </div>
                                <div style="margin-top: 15px; font-size: 12px; color: #6c757d;">
                                    üí° Click on the map marker to see details. You can also export to Excel or copy coordinates.
                                </div>
                            `;
                            resultDiv.innerHTML = resultHtml;
                            resultDiv.className = 'single-address-result success';
                        } else {
                            mapContainer.style.display = 'none';
                            showSingleAddressResult(resultDiv, 
                                `‚ùå Failed to geocode address: ${address}\n\n` +
                                `Error: ${geocodedAddress.errorMessage || 'Unknown error'}\n\n` +
                                `Please check the address format and try again.`, 
                                'error');
                        }
                    } else {
                        mapContainer.style.display = 'none';
                        showSingleAddressResult(resultDiv, 
                            `‚ùå Failed to geocode address: ${address}\n\n` +
                            `Please check the address format and try again.`, 
                            'error');
                    }
                } else {
                    mapContainer.style.display = 'none';
                    showSingleAddressResult(resultDiv, `‚ùå Error: ${result}`, 'error');
                }
            } catch (error) {
                mapContainer.style.display = 'none';
                showSingleAddressResult(resultDiv, `‚ùå Error: ${error.message}`, 'error');
            } finally {
                checkBtn.disabled = false;
                checkBtn.textContent = 'üîç Check Address';
            }
        }

        async function exportSingleAddress(address, longitude, latitude) {
            try {
                const response = await fetch(`${baseUrl}/api/excelgeocoding/geocode-and-export?simpleFormat=true`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify([address])
                });

                const result = await response.json();
                
                if (response.ok) {
                    const downloadLink = `${baseUrl}/api/excelgeocoding/download/${result.fileName}`;
                    const link = document.createElement('a');
                    link.href = downloadLink;
                    link.download = result.fileName;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                    // Show success message
                    const exportBtn = document.querySelector('.btn-export');
                    const originalText = exportBtn.textContent;
                    exportBtn.textContent = '‚úÖ Exported!';
                    exportBtn.className = 'btn-export copy-success';
                    setTimeout(() => {
                        exportBtn.textContent = originalText;
                        exportBtn.className = 'btn-export';
                    }, 2000);
                }
            } catch (error) {
                console.error('Export error:', error);
                alert('Error exporting to Excel: ' + error.message);
            }
        }

        function copyCoordinates(longitude, latitude) {
            const coordinates = `${longitude}, ${latitude}`;
            navigator.clipboard.writeText(coordinates).then(() => {
                const copyBtn = document.querySelector('.btn-copy');
                const originalText = copyBtn.textContent;
                copyBtn.textContent = '‚úÖ Copied!';
                copyBtn.className = 'btn-copy copy-success';
                setTimeout(() => {
                    copyBtn.textContent = originalText;
                    copyBtn.className = 'btn-copy';
                }, 2000);
            }).catch(err => {
                console.error('Copy failed:', err);
                alert('Failed to copy coordinates');
            });
        }

        function showSingleAddressResult(element, message, type) {
            element.innerHTML = message;
            element.className = `single-address-result ${type}`;
            element.style.display = 'block';
        }

        async function processAndExport() {
            const fileInput = document.getElementById('excelFile');
            const resultDiv = document.getElementById('processResult');
            const progressBar = document.getElementById('progressBar');
            const progressBarFill = document.getElementById('progressBarFill');
            const processBtn = document.getElementById('processBtn');
            
            if (!fileInput.files[0]) {
                showResult(resultDiv, 'Please select a file first.', 'error');
                return;
            }

            const format = document.querySelector('input[name="format"]:checked').value;
            const simpleFormat = format === 'simple';

            const formData = new FormData();
            formData.append('file', fileInput.files[0]);

            try {
                processBtn.disabled = true;
                progressBar.style.display = 'block';
                
                // Simulate progress
                let progress = 0;
                const progressInterval = setInterval(() => {
                    progress += 10;
                    progressBarFill.style.width = progress + '%';
                    if (progress >= 90) clearInterval(progressInterval);
                }, 200);

                const response = await fetch(`${baseUrl}/api/excelgeocoding/process-and-export?simpleFormat=${simpleFormat}`, {
                    method: 'POST',
                    body: formData
                });

                clearInterval(progressInterval);
                progressBarFill.style.width = '100%';

                const result = await response.json();
                
                if (response.ok) {
                    const downloadLink = `${baseUrl}/api/excelgeocoding/download/${result.fileName}`;
                    const limitInfo = showProcessingLimits(result);
                    const statsHtml = showDetailedStats(result);
                    
                    showResult(resultDiv, 
                        `‚úÖ Success: ${result.message}\n\n` +
                        `${statsHtml}\n\n` +
                        `üìä Statistics:\n` +
                        `‚Ä¢ Total Processed: ${result.totalProcessed}\n` +
                        `‚Ä¢ Successful: ${result.successCount}\n` +
                        `‚Ä¢ Failed: ${result.failedCount}\n\n` +
                        `${limitInfo}\n\n` +
                        `üìÅ File: ${result.fileName}\n\n` +
                        `<a href="${downloadLink}" class="download-link" download>‚¨áÔ∏è Download Excel File</a>`, 
                        'success');
                } else {
                    showResult(resultDiv, `‚ùå Error: ${result}`, 'error');
                }
            } catch (error) {
                showResult(resultDiv, `‚ùå Error: ${error.message}`, 'error');
            } finally {
                processBtn.disabled = false;
                setTimeout(() => {
                    progressBar.style.display = 'none';
                    progressBarFill.style.width = '0%';
                }, 1000);
            }
        }

        async function processAddressList() {
            const addressList = document.getElementById('addressList').value;
            const resultDiv = document.getElementById('processListResult');
            const processListBtn = document.getElementById('processListBtn');
            
            if (!addressList.trim()) {
                showResult(resultDiv, 'Please enter at least one address.', 'error');
                return;
            }

            const addresses = addressList.split('\n').filter(addr => addr.trim() !== '');
            const format = document.querySelector('input[name="format2"]:checked').value;
            const simpleFormat = format === 'simple';

            try {
                processListBtn.disabled = true;

                const response = await fetch(`${baseUrl}/api/excelgeocoding/geocode-and-export?simpleFormat=${simpleFormat}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(addresses)
                });

                const result = await response.json();
                
                if (response.ok) {
                    const downloadLink = `${baseUrl}/api/excelgeocoding/download/${result.fileName}`;
                    const limitInfo = showProcessingLimits(result);
                    const statsHtml = showDetailedStats(result);
                    
                    showResult(resultDiv, 
                        `‚úÖ Success: ${result.message}\n\n` +
                        `${statsHtml}\n\n` +
                        `üìä Statistics:\n` +
                        `‚Ä¢ Total Processed: ${result.processedCount}\n` +
                        `‚Ä¢ Successful: ${result.successCount}\n` +
                        `‚Ä¢ Failed: ${result.failedCount}\n\n` +
                        `${limitInfo}\n\n` +
                        `üìÅ File: ${result.fileName}\n\n` +
                        `<a href="${downloadLink}" class="download-link" download>‚¨áÔ∏è Download Excel File</a>`, 
                        'success');
                } else {
                    showResult(resultDiv, `‚ùå Error: ${result}`, 'error');
                }
            } catch (error) {
                showResult(resultDiv, `‚ùå Error: ${error.message}`, 'error');
            } finally {
                processListBtn.disabled = false;
            }
        }

        async function listExports() {
            const exportsListDiv = document.getElementById('exportsList');
            
            try {
                const response = await fetch(`${baseUrl}/api/excelgeocoding/list-exports`);
                const result = await response.json();
                
                if (response.ok) {
                    if (result.files.length === 0) {
                        exportsListDiv.innerHTML = '<p>No export files found.</p>';
                    } else {
                        const filesHtml = result.files.map(file => `
                            <div class="export-item">
                                <div>
                                    <strong>${file.fileName}</strong><br>
                                    <small>Size: ${(file.fileSize / 1024).toFixed(1)} KB | Created: ${new Date(file.createdDate).toLocaleString()}</small>
                                </div>
                                <a href="${file.downloadUrl}" class="download-link" download>‚¨áÔ∏è Download</a>
                            </div>
                        `).join('');
                        exportsListDiv.innerHTML = filesHtml;
                    }
                    exportsListDiv.style.display = 'block';
                } else {
                    exportsListDiv.innerHTML = `<p class="error">Error loading exports: ${result}</p>`;
                    exportsListDiv.style.display = 'block';
                }
            } catch (error) {
                exportsListDiv.innerHTML = `<p class="error">Error: ${error.message}</p>`;
                exportsListDiv.style.display = 'block';
            }
        }

        function showResult(element, message, type) {
            element.innerHTML = message;
            element.className = `result ${type}`;
            element.style.display = 'block';
        }

        // Load exports list on page load
        window.onload = function() {
            listExports();
            loadConfiguration();
        };

        async function loadConfiguration() {
            try {
                const response = await fetch(`${baseUrl}/api/excelgeocoding/configuration`);
                const config = await response.json();
                
                const costControlInfo = document.getElementById('costControlInfo');
                if (config.processingLimits && config.processingLimits.enableProcessingLimits) {
                    costControlInfo.innerHTML = `
                        <strong>üí∞ Cost Control:</strong> Processing is limited to <strong>${config.processingLimits.maxAddressesPerFile} addresses per file</strong> to save money during testing. 
                        You can adjust this limit in the configuration.
                    `;
                } else {
                    costControlInfo.innerHTML = `
                        <strong>üí∞ Cost Control:</strong> Processing is not limited.
                    `;
                }

                const configDisplay = document.getElementById('configurationDisplay');
                configDisplay.innerHTML = JSON.stringify(config, null, 2); // Pretty print JSON
                configDisplay.style.display = 'block';

            } catch (error) {
                console.error('Error loading configuration:', error);
                const costControlInfo = document.getElementById('costControlInfo');
                costControlInfo.innerHTML = `
                    <strong>üí∞ Cost Control:</strong> Error loading configuration.
                `;
                const configDisplay = document.getElementById('configurationDisplay');
                configDisplay.innerHTML = `<p class="error">Error: ${error.message}</p>`;
                configDisplay.style.display = 'block';
            }
        }

        // Add Enter key support for single address input
        document.getElementById('singleAddress').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                checkSingleAddress();
            }
        });

        function startLiveLogs() {
            if (eventSource) {
                console.warn("Live logs are already running.");
                return;
            }

            const logsContainer = document.getElementById('liveLogsContainer');
            const logsDiv = document.getElementById('liveLogs');
            
            logsContainer.style.display = 'block';
            logsDiv.innerHTML = 'üîÑ Connecting to live log stream...\n';

            eventSource = new EventSource(`${baseUrl}/api/excelgeocoding/live-logs`);
            
            eventSource.onopen = function() {
                logsDiv.innerHTML += '‚úÖ Connected to live log stream\n';
                document.getElementById('startLogsBtn').style.display = 'none';
                document.getElementById('stopLogsBtn').style.display = 'inline-block';
                document.getElementById('clearLogsBtn').style.display = 'inline-block';
            };

            eventSource.onmessage = function(event) {
                try {
                    const logEntry = JSON.parse(event.data);
                    
                    // Handle timestamp parsing more robustly
                    let timestamp;
                    if (logEntry.timestamp) {
                        // Try parsing as ISO string first
                        const date = new Date(logEntry.timestamp);
                        if (!isNaN(date.getTime())) {
                            timestamp = date.toLocaleTimeString();
                        } else {
                            // Fallback to current time
                            timestamp = new Date().toLocaleTimeString();
                        }
                    } else {
                        timestamp = new Date().toLocaleTimeString();
                    }
                    
                    const type = logEntry.type || 'info';
                    const message = logEntry.message || '';
                    
                    const logLine = `[${timestamp}] ${getTypeIcon(type)} ${message}\n`;
                    logsDiv.innerHTML += logLine;
                    
                    // Keep only last 100 lines
                    const lines = logsDiv.innerHTML.split('\n');
                    if (lines.length > 100) {
                        logsDiv.innerHTML = lines.slice(-100).join('\n');
                    }
                    
                    // Scroll to bottom
                    logsDiv.scrollTop = logsDiv.scrollHeight;
                } catch (error) {
                    console.error('Error parsing log entry:', error);
                    // Fallback for malformed entries
                    const fallbackLine = `[${new Date().toLocaleTimeString()}] üìù ${event.data}\n`;
                    logsDiv.innerHTML += fallbackLine;
                }
            };

            eventSource.onerror = function(error) {
                logsDiv.innerHTML += '‚ùå Connection error. Retrying...\n';
                console.error('EventSource error:', error);
            };

            console.log("Live logs started.");
        }

        function stopLiveLogs() {
            if (eventSource) {
                eventSource.close();
                eventSource = null;
                document.getElementById('startLogsBtn').style.display = 'inline-block';
                document.getElementById('stopLogsBtn').style.display = 'none';
                document.getElementById('clearLogsBtn').style.display = 'none';
                console.log("Live logs stopped.");
            }
        }

        function clearLogs() {
            const logsDiv = document.getElementById('liveLogs');
            logsDiv.innerHTML = '';
            console.log("Logs cleared.");
        }

        function getTypeIcon(type) {
            switch (type) {
                case 'success': return '‚úÖ';
                case 'error': return '‚ùå';
                case 'warning': return '‚ö†Ô∏è';
                case 'info': return '‚ÑπÔ∏è';
                default: return 'üìù';
            }
        }
    </script>
</body>
</html> 